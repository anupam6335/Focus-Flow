import mongoose from 'mongoose';
import Todo from '../models/Todo.js';
import StructuredTodo from '../models/StructuredTodo.js';
import config from '../config/environment.js';

console.log('ğŸš€ Starting todo migration...');

const migrateTodos = async () => {
  let connection;
  try {
    console.log('ğŸ“¡ Connecting to database...');
    connection = await mongoose.connect(config.MONGODB_URI);
    console.log('âœ… Connected to database:', mongoose.connection.db.databaseName);

    // Get all existing todos
    console.log('ğŸ“‹ Fetching existing todos...');
    const todos = await Todo.find({});
    console.log(`ğŸ“Š Found ${todos.length} todos to migrate`);

    if (todos.length === 0) {
      console.log('â„¹ï¸ No todos found to migrate');
      return;
    }

    // Get unique users
    const userIds = [...new Set(todos.map(todo => todo.userId))];
    console.log(`ğŸ‘¥ Found ${userIds.length} users:`, userIds);

    let totalMigrated = 0;
    let userCount = 0;

    // Process each user
    for (const userId of userIds) {
      userCount++;
      console.log(`\n--- Processing user ${userCount}/${userIds.length}: ${userId} ---`);

      // Get user's todos
      const userTodos = todos.filter(todo => todo.userId === userId);
      console.log(`ğŸ“ User has ${userTodos.length} todos`);

      // Group todos by date
      const todosByDate = {};
      userTodos.forEach(todo => {
        if (!todosByDate[todo.dueDate]) {
          todosByDate[todo.dueDate] = [];
        }
        todosByDate[todo.dueDate].push(todo);
      });

      console.log(`ğŸ“… Found ${Object.keys(todosByDate).length} unique dates`);

      // Create days array
      const days = Object.entries(todosByDate).map(([date, dateTodos]) => {
        const todosForDay = dateTodos.map(todo => ({
          _id: todo._id,
          title: todo.title,
          notes: todo.notes,
          status: todo.status,
          completed: todo.status === 'done',
          dueDate: todo.dueDate,
          sourceDate: todo.sourceDate,
          order: todo.order,
          autoGenerated: todo.autoGenerated,
          attachedToSandclock: todo.attachedToSandclock,
          createdAt: todo.createdAt,
          updatedAt: todo.updatedAt
        }));

        return {
          date,
          todos: todosForDay
        };
      });

      // Check if structured todo already exists
      let structuredTodo = await StructuredTodo.findOne({ userId });
      
      if (structuredTodo) {
        console.log(`ğŸ”„ Updating existing structured todos for user ${userId}`);
        structuredTodo.days = days;
      } else {
        console.log(`ğŸ†• Creating new structured todos for user ${userId}`);
        structuredTodo = new StructuredTodo({
          userId,
          days,
          lastProcessed: null
        });
      }

      await structuredTodo.save();
      totalMigrated += userTodos.length;
      console.log(`âœ… Successfully migrated ${userTodos.length} todos for ${userId}`);
    }

    console.log('\nğŸ‰ MIGRATION COMPLETED SUCCESSFULLY!');
    console.log('=====================================');
    console.log(`ğŸ“Š Total users processed: ${userCount}`);
    console.log(`ğŸ“ Total todos migrated: ${totalMigrated}`);
    console.log(`ğŸ Original todo count: ${todos.length}`);

    // Verify counts match
    if (totalMigrated === todos.length) {
      console.log('âœ… All todos migrated successfully!');
    } else {
      console.log(`âš ï¸  Count mismatch: expected ${todos.length}, migrated ${totalMigrated}`);
    }

  } catch (error) {
    console.error('âŒ MIGRATION FAILED:', error);
    console.error('Error details:', error.message);
    if (error.stack) {
      console.error('Stack trace:', error.stack);
    }
  } finally {
    if (mongoose.connection.readyState !== 0) {
      await mongoose.disconnect();
      console.log('ğŸ”Œ Disconnected from database');
    }
    console.log('ğŸ Migration script finished');
  }
};

// Run the migration
migrateTodos();