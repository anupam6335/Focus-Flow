const mongoose = require('mongoose');
const Todo = require('../models/Todo.js');
const StructuredTodo = require('../models/StructuredTodo.js');
const config = require('../config/environment.js');

console.log('ğŸš€ Starting todo migration (CJS version)...');

const migrateTodos = async () => {
  try {
    console.log('ğŸ“¡ Connecting to database...');
    await mongoose.connect(config.MONGODB_URI);
    console.log('âœ… Connected to database');

    // Get all existing todos
    console.log('ğŸ“‹ Fetching existing todos...');
    const todos = await Todo.find({});
    console.log(`ğŸ“Š Found ${todos.length} todos to migrate`);

    if (todos.length === 0) {
      console.log('â„¹ï¸ No todos found to migrate');
      return;
    }

    // Get unique users
    const userIds = [...new Set(todos.map(todo => todo.userId))];
    console.log(`ğŸ‘¥ Found ${userIds.length} users`);

    let totalMigrated = 0;

    for (const userId of userIds) {
      console.log(`\nğŸ‘¤ Processing user: ${userId}`);

      const userTodos = todos.filter(todo => todo.userId === userId);
      
      // Group by date
      const days = [];
      const dateMap = new Map();

      userTodos.forEach(todo => {
        if (!dateMap.has(todo.dueDate)) {
          dateMap.set(todo.dueDate, []);
        }
        dateMap.get(todo.dueDate).push({
          _id: todo._id,
          title: todo.title,
          notes: todo.notes,
          status: todo.status,
          completed: todo.status === 'done',
          dueDate: todo.dueDate,
          sourceDate: todo.sourceDate,
          order: todo.order,
          autoGenerated: todo.autoGenerated,
          attachedToSandclock: todo.attachedToSandclock,
          createdAt: todo.createdAt,
          updatedAt: todo.updatedAt
        });
      });

      // Convert map to days array
      dateMap.forEach((todos, date) => {
        days.push({ date, todos });
      });

      // Create or update structured todo
      await StructuredTodo.findOneAndUpdate(
        { userId },
        { 
          userId,
          days,
          lastProcessed: null
        },
        { upsert: true }
      );

      totalMigrated += userTodos.length;
      console.log(`âœ… Migrated ${userTodos.length} todos for ${userId}`);
    }

    console.log('\nğŸ‰ MIGRATION COMPLETED!');
    console.log(`ğŸ“ Total todos migrated: ${totalMigrated}`);

  } catch (error) {
    console.error('âŒ Migration error:', error);
  } finally {
    await mongoose.disconnect();
    console.log('ğŸ”Œ Disconnected from database');
  }
};

migrateTodos();